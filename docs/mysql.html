<!DOCTYPE html>  <html> <head>   <title>mysql.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="base-query.html">                 base-query.coffee               </a>                                           <a class="source" href="common.html">                 common.coffee               </a>                                           <a class="source" href="index.html">                 index.coffee               </a>                                           <a class="source" href="mysql.html">                 mysql.coffee               </a>                                           <a class="source" href="fluid.html">                 fluid.js               </a>                                           <a class="source" href="index.html">                 index.coffee               </a>                                           <a class="source" href="insert.html">                 insert.coffee               </a>                                           <a class="source" href="normalize.html">                 normalize.coffee               </a>                                           <a class="source" href="select.html">                 select.coffee               </a>                                           <a class="source" href="sud-query.html">                 sud-query.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               mysql.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nv">common = </span><span class="nx">require</span> <span class="s1">&#39;./common&#39;</span>
<span class="p">[</span><span class="nx">JOIN_TYPES</span><span class="p">,</span> <span class="nx">DEFAULT</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;JOIN_TYPES&#39;</span><span class="p">,</span> <span class="s1">&#39;DEFAULT&#39;</span><span class="p">].</span><span class="nx">map</span><span class="p">(</span><span class="nf">(k) -&gt;</span> <span class="nx">common</span><span class="p">[</span><span class="nx">k</span><span class="p">])</span>

<span class="nv">PLACEHOLDER = </span><span class="s1">&#39;?&#39;</span>
<span class="nv">DEFAULT_JOIN = </span><span class="nx">JOIN_TYPES</span><span class="p">.</span><span class="nx">INNER</span>


<span class="nv">exports.renderSelect = </span><span class="nf">(qs) -&gt;</span>
	<span class="s2">&quot;SELECT &quot;</span> <span class="o">+</span> <span class="p">[</span>
		<span class="nx">fields</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">where</span><span class="p">,</span> <span class="nx">group</span><span class="p">,</span> <span class="nx">order</span><span class="p">,</span> <span class="nx">limit</span>
	<span class="p">].</span><span class="nx">map</span><span class="p">(</span><span class="nf">(f) -&gt;</span> <span class="nx">f</span> <span class="nx">qs</span><span class="p">).</span><span class="nx">join</span> <span class="s1">&#39;&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Returns the field list portion of a query</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">fields = </span><span class="nf">(qs) -&gt;</span>
	<span class="nv">fs = </span><span class="p">[]</span>
	<span class="k">for</span> <span class="nx">tbl</span><span class="p">,</span> <span class="nx">tbl_fields</span> <span class="k">of</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">fields</span>
		<span class="k">continue</span> <span class="nx">unless</span> <span class="nx">tbl_fields</span><span class="o">?</span>
		<span class="k">if</span> <span class="nx">tbl_fields</span><span class="p">.</span><span class="nx">length</span>
			<span class="k">for</span> <span class="nx">f</span> <span class="k">in</span> <span class="nx">tbl_fields</span>
				<span class="nx">fs</span><span class="p">.</span><span class="nx">push</span> <span class="k">if</span> <span class="nx">f</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nx">f</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">then</span> <span class="s2">&quot;#{tbl}.#{f[0]}&quot;</span> <span class="k">else</span> <span class="s2">&quot;#{tbl}.#{f[0]} AS &#39;#{f[1]}&#39;&quot;</span>
		<span class="k">else</span>
			<span class="nx">fs</span><span class="p">.</span><span class="nx">push</span> <span class="s2">&quot;#{tbl}.*&quot;</span>
	<span class="nx">fs</span><span class="p">.</span><span class="nx">join</span> <span class="s1">&#39;, &#39;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Returns the 'FROM' portion of a query</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">from = exports.from = </span><span class="nf">(qs) -&gt;</span>
	<span class="nv">i = </span><span class="mi">0</span>
	<span class="nv">tables = </span><span class="k">for</span> <span class="p">[</span><span class="nx">table</span><span class="p">,</span> <span class="nx">alias</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">clause</span><span class="p">]</span> <span class="k">in</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">tableStack</span>
		<span class="k">continue</span> <span class="k">if</span> <span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;NOP&#39;</span>

		<span class="nv">ret = </span><span class="k">if</span> <span class="nx">i</span><span class="o">++</span> <span class="k">then</span> <span class="s2">&quot;#{type.toUpperCase()} JOIN #{table}&quot;</span> <span class="k">else</span> <span class="nx">table</span>

		<span class="k">if</span> <span class="nx">table</span> <span class="o">!=</span> <span class="nx">alias</span> <span class="k">then</span> <span class="nx">ret</span> <span class="o">+=</span> <span class="s2">&quot; AS #{alias}&quot;</span>
		<span class="k">if</span> <span class="nx">clause</span><span class="o">?</span> <span class="k">then</span> <span class="nx">ret</span> <span class="o">+=</span> <span class="s2">&quot; ON #{renderClause clause, (v) -&gt; v}&quot;</span>
		<span class="nx">ret</span>
	<span class="s1">&#39; FROM &#39;</span> <span class="o">+</span> <span class="nx">tables</span><span class="p">.</span><span class="nx">join</span> <span class="s1">&#39; &#39;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Returns the 'WHERE' portion of a query</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">where = exports.where = </span><span class="nf">(qs) -&gt;</span>
	<span class="k">if</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">where</span><span class="p">.</span><span class="nx">length</span> <span class="k">then</span> <span class="s2">&quot; WHERE #{renderClause qs.where}&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Returns the 'GROUP BY' portion of a query</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">group = exports.group = </span><span class="nf">(qs) -&gt;</span>
	<span class="k">if</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">groupings</span><span class="p">.</span><span class="nx">length</span>
		<span class="s2">&quot; GROUP BY #{qs.groupings.map((g) -&gt; g.table+&#39;.&#39;+g.field).join &#39;, &#39;}&quot;</span>
	<span class="k">else</span> <span class="s2">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Returns the 'ORDER BY' portion of a query</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">order = exports.order = </span><span class="nf">(qs) -&gt;</span>
	<span class="k">if</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">order</span><span class="p">.</span><span class="nx">length</span>
		<span class="s2">&quot; ORDER BY #{qs.order.map((o) -&gt;</span>
<span class="s2">			o.table+&#39;.&#39;+o.field + if o.direction then &#39; &#39;+o.direction else &#39;&#39;</span>
<span class="s2">		).join &#39;, &#39;}&quot;</span>
	<span class="k">else</span> <span class="s2">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Returns the 'LIMIT' portion of a query
TODO - parseInt</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">limit = </span><span class="nf">(qs) -&gt;</span> <span class="k">if</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">limit</span><span class="o">?</span> <span class="k">then</span> <span class="s2">&quot; LIMIT #{qs.limit}&quot;</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Given a query parameter, returns a <code>PLACEHOLDER</code>. Given an array as the parameter, renders
a list of <code>PLACEHOLDER</code> tokens equal in length to the array.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">renderBoundParam = </span><span class="nf">(v) -&gt;</span>
	<span class="k">if</span> <span class="nx">v</span> <span class="o">and</span> <span class="nx">v</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">==</span> <span class="nb">Array</span> <span class="k">then</span> <span class="s2">&quot;(#{v.map(-&gt; PLACEHOLDER).join &#39;, &#39;})&quot;</span>
	<span class="k">else</span> <span class="nx">PLACEHOLDER</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Renders an individual query clause</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.renderClause = renderClause = </span><span class="nf">(input, renderValue=renderBoundParam) -&gt;</span>
	<span class="nv">render = </span><span class="nf">(clause) -&gt;</span>
		<span class="k">if</span> <span class="nx">clause</span><span class="o">?</span> <span class="o">and</span> <span class="nx">clause</span><span class="p">.</span><span class="nx">constructor</span> <span class="o">==</span> <span class="nb">Array</span>
			<span class="s2">&quot;#{clause.map(render).join(&#39; AND &#39;)}&quot;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">clause</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span>
			<span class="k">if</span> <span class="nx">clause</span><span class="p">.</span><span class="nx">op</span> <span class="o">==</span> <span class="s1">&#39;multi&#39;</span>
				<span class="s2">&quot;(#{clause.clauses.map(render).join(clause.glue)})&quot;</span>
			<span class="k">else</span>
				<span class="s2">&quot;#{clause.table}.#{clause.field} #{clause.op} #{renderValue clause.value}&quot;</span>
		<span class="k">else</span>
			<span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;Unexpected clause type, this is probably a bug&quot;</span>
	<span class="nx">render</span> <span class="nx">input</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>TODO - check whether there is any difference in the supported comparison operators</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">exports.joinOp = exports.whereOp = </span><span class="nf">(op) -&gt;</span>
	<span class="k">switch</span> <span class="nx">op</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
		<span class="k">when</span> <span class="s1">&#39;ne&#39;</span><span class="p">,</span> <span class="s1">&#39;!=&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&gt;&#39;</span> <span class="k">then</span> <span class="s1">&#39;!=&#39;</span>
		<span class="k">when</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;=&#39;</span>   <span class="k">then</span> <span class="s1">&#39;=&#39;</span>
		<span class="k">when</span> <span class="s1">&#39;lt&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;&#39;</span>   <span class="k">then</span> <span class="s1">&#39;&lt;&#39;</span>
		<span class="k">when</span> <span class="s1">&#39;gt&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;&#39;</span>   <span class="k">then</span> <span class="s1">&#39;&gt;&#39;</span>
		<span class="k">when</span> <span class="s1">&#39;lte&#39;</span><span class="p">,</span> <span class="s1">&#39;&lt;=&#39;</span> <span class="k">then</span> <span class="s1">&#39;&lt;=&#39;</span>
		<span class="k">when</span> <span class="s1">&#39;gte&#39;</span><span class="p">,</span> <span class="s1">&#39;&gt;=&#39;</span> <span class="k">then</span> <span class="s1">&#39;&gt;=&#39;</span>
		<span class="k">when</span> <span class="s1">&#39;like&#39;</span> <span class="k">then</span> <span class="s1">&#39;LIKE&#39;</span>
		<span class="k">when</span> <span class="s1">&#39;in&#39;</span> <span class="k">then</span> <span class="s1">&#39;IN&#39;</span>
		<span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span><span class="p">(</span><span class="s2">&quot;Unsupported comparison operator: #{op}&quot;</span><span class="p">)</span>

<span class="nv">exports.joinType = </span><span class="nf">(type) -&gt;</span>
	<span class="k">return</span> <span class="s1">&#39;INNER&#39;</span> <span class="nx">unless</span> <span class="nx">type</span>
	<span class="nv">type = </span><span class="nx">type</span><span class="p">.</span><span class="nx">toUpperCase</span><span class="p">()</span>
	<span class="k">if</span> <span class="nx">type</span> <span class="k">in</span> <span class="nx">JOIN_TYPES</span> <span class="k">then</span> <span class="nx">type</span>
	<span class="k">else</span> <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s2">&quot;Unsupported JOIN type #{type}&quot;</span>

<span class="nv">exports.renderInsert = </span><span class="nf">(qs) -&gt;</span>
	<span class="s2">&quot;INSERT INTO #{qs.table} (#{qs.fields.join &#39;, &#39;}) VALUES #{renderInsertParams qs}&quot;</span>

<span class="nv">renderInsertParams = </span><span class="nf">(qs) -&gt;</span>
	<span class="nv">rows = </span><span class="k">for</span> <span class="p">[</span><span class="mi">1</span> <span class="p">..</span> <span class="nx">qs</span><span class="p">.</span><span class="nx">parameters</span><span class="p">.</span><span class="nx">length</span> <span class="err">/ qs.fields.length]</span>
		<span class="nx">renderBoundParam</span> <span class="p">[</span><span class="mi">1</span><span class="p">..</span><span class="nx">qs</span><span class="p">.</span><span class="nx">fields</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
	<span class="nx">rows</span><span class="p">.</span><span class="nx">join</span> <span class="s2">&quot;, &quot;</span>

<span class="nv">exports.renderInsertSelect = </span><span class="nf">(qs) -&gt;</span>
	<span class="s2">&quot;INSERT INTO #{table} #{qs.fromQuery.toSql()}&quot;</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 